homeassistant:
  customize:
    sensor.hp_envy_5000_series_black_ink:
      friendly_name: Encore noire
    sensor.hp_envy_5000_series_tri_color_ink:
      friendly_name: Encre couleurs


# Inspired by: https://community.home-assistant.io/t/command-line-sensor-with-a-value-template-struggling/125957/3
template:
  - sensor:
    - default_entity_id: sensor.hp_envy_5540_pages_allowance_remaining
      icon: mdi:printer
      name: Pages restantes
      state: "{% if states('input_datetime.hp_envy_5540_this_period_start_date') %}\n
        \ {% if states('input_number.hp_envy_5540_pages_at_month_start')|int + states('input_number.hp_envy_5540_pages_monthly_allowance')|int
        - states('sensor.web_scrape')|int >= 0 %}\n    {{ states('input_number.hp_envy_5540_pages_at_month_start')|int
        + states('input_number.hp_envy_5540_pages_monthly_allowance')|int - states('sensor.web_scrape')|int
        }}\n  {% else %}\n    0\n  {% endif %}\n{% endif %}"
  - sensor:
    - default_entity_id: sensor.hp_envy_5540_pages_rollover_remaining
      icon: mdi:tray-plus
      name: Pages reportées restantes
      state: "{% if states('input_datetime.hp_envy_5540_this_period_start_date') %}\n
        \ {% if states('input_number.hp_envy_5540_pages_at_month_start')|int + states('input_number.hp_envy_5540_pages_monthly_allowance')|int
        - states('sensor.web_scrape')|int < 0 and states('input_number.hp_envy_5540_pages_at_month_start')|int
        + states('input_number.hp_envy_5540_pages_monthly_allowance')|int + states('input_number.hp_envy_5540_pages_rollover_allowance')|int
        - states('sensor.web_scrape')|int >= 0 %}\n    {{ states('input_number.hp_envy_5540_pages_at_month_start')|int
        + states('input_number.hp_envy_5540_pages_monthly_allowance')|int + states('input_number.hp_envy_5540_pages_rollover_allowance')|int
        - states('sensor.web_scrape')|int }}\n  {% elif states('input_number.hp_envy_5540_pages_at_month_start')|int
        + states('input_number.hp_envy_5540_pages_monthly_allowance')|int - states('sensor.web_scrape')|int
        < 0 and states('input_number.hp_envy_5540_pages_at_month_start')|int + states('input_number.hp_envy_5540_pages_monthly_allowance')|int
        + states('input_number.hp_envy_5540_pages_rollover_allowance')|int -   states('sensor.web_scrape')|int
        < 0 %}\n    0\n  {% elif 1==1 %}\n    {{ states('input_number.hp_envy_5540_pages_rollover_allowance')|int
        }}\n  {% endif %}\n{% endif %}"
  - sensor:
    - default_entity_id: sensor.hp_envy_5540_pages_overprint
      icon: mdi:text-box-plus-outline
      name: Pack payant
      state: "{% if states('input_datetime.hp_envy_5540_this_period_start_date') %}\n
        \ {% if states('input_number.hp_envy_5540_pages_at_month_start')|int + states('input_number.hp_envy_5540_pages_monthly_allowance')|int
        + states('input_number.hp_envy_5540_pages_rollover_allowance')|int < states('sensor.web_scrape')|int
        %}\n    {{ states('sensor.web_scrape')|int - states('input_number.hp_envy_5540_pages_rollover_allowance')|int
        - states('input_number.hp_envy_5540_pages_monthly_allowance')|int - states('input_number.hp_envy_5540_pages_at_month_start')|int
        }}\n  {% else %}\n    0\n  {% endif %}    \n{% endif %}"
  - sensor:
    - unit_of_measurement: €
      default_entity_id: sensor.hp_envy_5540_pages_overprint_cost
      icon: mdi:currency-eur
      name: Cout supplémentaire
      state: "{% if states('input_datetime.hp_envy_5540_total_pages_printed') or states('input_datetime.hp_envy_5540_this_period_start_date')
        %}\n  {% if states('sensor.hp_envy_5540_pages_overprint')|int == 0 %}\n    0\n
        \ {% elif states('sensor.hp_envy_5540_pages_overprint')|int > 0 and ( (states('sensor.hp_envy_5540_pages_overprint')|int
        - 1) % states('input_number.hp_envy_5540_pages_overprint_block_size')|int ==
        0 ) %}\n    {{ (1 + ((states('sensor.hp_envy_5540_pages_overprint')|int - 1)
        / states('input_number.hp_envy_5540_pages_overprint_block_size')|int)) | multiply(
        states('input_number.hp_envy_5540_pages_overprint_block_cost')|int)|int  }}\n
        \ {% else %}\n    {{ (1 + ((states('sensor.hp_envy_5540_pages_overprint')|int
        - 1) / states('input_number.hp_envy_5540_pages_overprint_block_size')|int))
        | multiply( states('input_number.hp_envy_5540_pages_overprint_block_cost')|int)|int
        \ }}\n  {% endif %}    \n{% endif %}"
  - sensor:
    - default_entity_id: sensor.hp_envy_5540_pages_overprint_remaining
      icon: mdi:book-open-page-variant-outline
      name: Pages du pack payant restantes
      state: "{% if states('sensor.hp_envy_5540_pages_overprint')|int == 0 or (states('sensor.hp_envy_5540_pages_overprint')|int
        % states('input_number.hp_envy_5540_pages_overprint_block_size')|int == 0) %}\n
        \ 0\n{% else %}\n  {{ states('input_number.hp_envy_5540_pages_overprint_block_size')|int
        - (states('sensor.hp_envy_5540_pages_overprint')|int % states('input_number.hp_envy_5540_pages_overprint_block_size')|int)
        }}\n{% endif %}"
  - sensor:
    - default_entity_id: sensor.hp_envy_5540_next_renewal_date
      name: HP Envy 5540 Next Renewal Date
      state: "{% if (states('input_datetime.hp_envy_5540_this_period_start_date').split(\"-\")[1]|int
        + 1 > 12) %}\n  {{ (states('input_datetime.hp_envy_5540_this_period_start_date').split(\"-\")[0]|int
        + 1)|string + \"-01-\" + states('input_datetime.hp_envy_5540_this_period_start_date').split(\"-\")[2]
        }}\n{% else %}\n  {{ states('input_datetime.hp_envy_5540_this_period_start_date').split(\"-\")[0]|int|string
        + \"-\" +  ('%02d' % (states('input_datetime.hp_envy_5540_this_period_start_date').split(\"-\")[1]|int
        + 1)) + \"-\" + states('input_datetime.hp_envy_5540_this_period_start_date').split(\"-\")[2]
        }}\n{% endif %}"
  - sensor:
    - default_entity_id: sensor.hp_envy_5540_allowance_days_remaining
      icon: mdi:calendar
      name: Jours restants
      state: '{{ ((as_timestamp(strptime(states(''sensor.hp_envy_5540_next_renewal_date''),
        ''%Y-%m-%d''),0)|int - as_timestamp(strptime(states(''sensor.date''), ''%Y-%m-%d''),0)|int
        ) / 86400)|int }}'
  - sensor:
    - default_entity_id: sensor.total_rollover_pages
      name: Impressions restantes
      state: '{{ states(''sensor.hp_envy_5540_pages_allowance_remaining'')|int(0) +
        states(''sensor.hp_envy_5540_pages_rollover_remaining'')|int(0) }}'


input_number:
  # The total number of pages that had been printed at the start of this period of the printing plan
  # Set by an automation
  hp_envy_5540_pages_at_month_start:
    name: Printed Pages Total at month start
    min: 100
    max: 10000
    step: 1
    icon: mdi:printer
    mode: box
  # The current monthly allowance number of pages
  # Set manually
  hp_envy_5540_pages_monthly_allowance:
    name: Monthly Allowance Pages
    min: 15
    max: 300
    step: 1
    icon: mdi:printer
    mode: box
  # The maximum number of rollover pages allowed.
  # Ten on the free tier, 2x pages on the paid tier.
  # Set manually
  hp_envy_5540_pages_rollover_monthly_max_allowance:
    name: Rollover Maximum Pages
    min: 0
    max: 600
    step: 1
    icon: mdi:printer
    mode: box
  # The rollover allowance for this month
  # Set by an automation
  hp_envy_5540_pages_rollover_allowance:
    name: Rollover Allowance Pages
    min: 0
    max: 600
    step: 1
    icon: mdi:printer
    mode: box
  # The number of pages in each overprint block, when
  # the Monthly Allowance plus Rollover are exceeded
  # Set manually
  hp_envy_5540_pages_overprint_block_size:
    name: Over Print Block Size
    min: 0
    max: 100
    step: 1
    icon: mdi:printer
    mode: box
  # The cost of each overprint block, in £
  # Set manually
  hp_envy_5540_pages_overprint_block_cost:
    name: Over Print Block Cost
    min: 0
    max: 50
    step: 0.01
    icon: mdi:currency-eur
    mode: box

input_datetime:
  hp_envy_5540_this_period_start_date:
    name: This Period Start Date
    has_date: true
    has_time: false
    icon: mdi:calendar

automation:
  - alias: HP Envy 5540 Page Reset
    description:
      "Sets: - Total number of pages printed at the start of the period -
      Start Date of this period (to store a date to calculate the next one) - Maximum
      Rollover Allowance value for this month - Rollover Remaining to new Maximum Rollover
      Allowance value for this month - Rollover from overprint pages"
    trigger:
      - at: 00:00:00
        platform: time
    condition:
      - condition: template
        value_template:
          "{{ now().day|int == states('input_datetime.hp_envy_5540_this_period_start_date')[-2:]|int
          }}"
    action:
      - service: input_number.set_value
        entity_id: input_number.hp_envy_5540_pages_rollover_allowance
        data_template:
          value:
            "{{ states('sensor.hp_envy_5540_pages_allowance_remaining')|int + states('sensor.hp_envy_5540_pages_rollover_remaining')|int }}"

      - service: input_number.set_value
        entity_id: input_number.hp_envy_5540_pages_at_month_start
        data_template:
          value: "{{ states('sensor.web_scrape') }}"
      - service: input_datetime.set_datetime
        entity_id: input_datetime.hp_envy_5540_this_period_start_date
        data_template:
          date: "{{ states('sensor.date') }}"